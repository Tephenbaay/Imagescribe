<!DOCTYPE html>
<html lang="en">
<head>
  <title>ImageScribe</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/static/logo.png/">
  <link rel="stylesheet" href="{{ url_for('static', filename='result.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='loading.css') }}">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
</head>
<body>
  <!-- Sticky Header -->
  <div class="tab">
          <p>ImageScribe</p>

    <button class="btn0" onclick="window.location.href='/index'">
      <img src="{{ url_for('static', filename='images/tab.png') }}" alt="tab button" width="40px" height="40px">
    </button>
  </div>
  <header class="header">
    <div class="user">
      <button class="btn01" onclick="window.location.href='/user'">
        <img src="{{ url_for('static', filename='images/user.png') }}" alt="user-button" width="40px" height="40px">
      </button>
    </div>
    <h1 class="logo"></h1>
    <div class="header-icons"></div>
  </header>

  <!-- Sidebar -->
  <div class="main-wrapper">
    <img class="menu" id="menu-btn" src="menu.png" alt="menu button" style="width: 40px; cursor: pointer;">
<div class="sidebar" id="sidebar">
    <h1 class="logo">ImageScribe</h1>
    <h4 class="text-center">History</h4><br>
    <ul class="list-group text-center">
        {% for history in upload_history %}
        <li class="list-group-item">
            <form action="{{ url_for('upload') }}" method="POST">
                <input type="hidden" name="filename" value="{{ history.filename }}">
                <button type="submit" class="btn btn-link w-100 text-left">{{ history.filename }}</button>
            </form>
        </li>
        {% else %}
        <li class="list-group-item">No uploads found.</li>
        {% endfor %}
    </ul>
</div>
  
    <!-- Main Content -->
    <div class="main-content">
      <div class="text-center">
        <img src="{{ url_for('static', filename='uploads/' + filename) }}" class="img-responsive img-thumbnail" style="max-height: 400px; max-width: 400px;">
      </div>

      <!-- Image Download Link -->
      <div class="text-center">
        <a href="{{ url_for('static', filename='uploads/' + filename) }}" download="{{ filename }}" class="btn12"></a>
      </div>

      <br>

      <!-- Caption and Description Card -->
      <div class="card" style="width: 100%; padding: 15px; margin: 10px auto; background-color: #E5E4E2;">
        <h2>Caption: <i id="caption">{{ caption }}</i>
          <button onclick="playAudio('{{ caption }}')">
            <img src="{{ url_for('static', filename='images/speaker.png') }}" alt="Play caption" width="24px">
          </button>
        </h2>

        <h2>Description:</h2>
        <h3 id="first-description" style="text-align: justify;">{{ first_description }}</h3>
        <h3 id="second-description" style="text-align: justify;">{{ second_description }}</h3>
        <h3 id="third-description" style="text-align: justify;">{{ third_description }}</h3>
        <button onclick="playDescriptionAudio()">
          <img src="{{ url_for('static', filename='images/speaker.png') }}" alt="Play description" width="24px">
        </button>

        <h3>Image Category: <i>{{ category }}</i></h3>
      </div>

      <!-- Download Buttons -->
      <div class="btn2">
        <button onclick="downloadTextFile()">Download Captions and Descriptions</button>
      </div>
      <div class="btn2">
        <button onclick="downloadImage()">Download Image</button>
      </div>

      <hr>
      <br>

      <!-- Image Upload Form -->
      <div class="container" style="margin-bottom: 30px;">
        <form class="form-horizontal" action="/submit" method="post" enctype="multipart/form-data" onsubmit="showLoading()">
          <div class="form-group">
            <label class="control-label col-sm-2" for="pwd"></label>
            <div class="col-sm-10">
              <input type="file" class="form-control" name="my_image" id="pwd" multiple required>
            </div>
          </div>
          <div class="form-group">
            <div class="col-sm-offset-2 col-sm-10">
              <button type="submit" class="btn btn-success" id="submit-btn">Submit</button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>

  <div class="back">
    <button class="btnn" onclick="window.location.href='/home'">
      <img src="/static/images/out.png/" alt="out button" width="40px" height="40px">
    </button>
  </div>

  <!-- Full-screen Loading Overlay -->
  <div id="loading-overlay" class="loading">
    <div class="loading-content">
      <p>Your image is being processed by our AI...</p>
      <img src="{{ url_for('static', filename='images/loading.gif') }}" alt="Loading..." class="loading-gif">
    </div>
  </div>

  <script>
    function showLoading() {
      document.getElementById('loading-overlay').style.display = 'flex';
      document.getElementById('submit-btn').disabled = true;
    }

    function downloadImage() {
      const imageUrl = "{{ url_for('static', filename='uploads/' + filename) }}";
      const link = document.createElement('a');
      link.href = imageUrl;
      link.download = "{{ filename }}";
      link.click();
    }

    function playAudio(text) {
      const speech = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(speech);
    }

    function playDescriptionAudio() {
      const descriptionText = "{{ first_description }} {{ second_description }} {{ third_description }}";
      const speech = new SpeechSynthesisUtterance(descriptionText);
      speechSynthesis.speak(speech);
    }

    function downloadTextFile() {
      const captionText = "{{ caption }}";
      const firstDescriptionText = "{{ first_description }}";
      const secondDescriptionText = "{{ second_description }}";
      const thirdDescriptionText = "{{ third_description }}";
      const textContent = `Caption: ${captionText}\n\nDescription:\n${firstDescriptionText}\n${secondDescriptionText}\n${thirdDescriptionText}`;

      const blob = new Blob([textContent], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = "caption_and_description.txt";
      link.click();
    }

    function typeEffect(elementId, text, delay = 20) {
      const element = document.getElementById(elementId);
      let index = 0;

      function type() {
        if (index < text.length) {
          element.textContent += text.charAt(index);
          index++;
          setTimeout(type, delay);
        }
      }

      type();
    }

    document.addEventListener("DOMContentLoaded", function () {
    const menuButton = document.getElementById("menu-btn");
    const sidebar = document.getElementById("sidebar");

    if (menuButton && sidebar) {
        menuButton.addEventListener("click", function () {
            sidebar.classList.toggle("visible");
        });
    } else {
        console.error("Menu button or sidebar not found!");
    }
});


  menuButton.addEventListener("click", function() {
  console.log("Menu button clicked!");
  sidebar.classList.toggle("visible");
});

    document.addEventListener('DOMContentLoaded', function () {
      const captionText = "{{ caption }}";
      const firstDescriptionText = "{{ first_description }}";
      const secondDescriptionText = "{{ second_description }}";
      const thirdDescriptionText = "{{ third_description }}";

      typeEffect("caption", captionText, 20); 
      typeEffect("first-description", firstDescriptionText, 20); 
      typeEffect("second-description", secondDescriptionText, 20); 
      typeEffect("third-description", thirdDescriptionText, 20);
    });
  </script>
</body>
</html>
